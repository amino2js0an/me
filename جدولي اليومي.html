<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“… Ø¬Ø¯ÙˆÙ„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ â€” ØªÙØ§Ø¹Ù„ÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f4f6fb; --text:#1f2937; --card:#ffffff; --muted:#6b7280; --acc:#22c55e; --acc-2:#0ea5e9; --danger:#ef4444; --border:#e5e7eb;
    }
    body.dark{ --bg:#0f172a; --text:#e5e7eb; --card:#111827; --muted:#94a3b8; --acc:#16a34a; --acc-2:#38bdf8; --danger:#f87171; --border:#1f2937; }
    *{ box-sizing: border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:"Tahoma",system-ui,sans-serif; }
    header{ position:sticky; top:0; z-index:50; background:linear-gradient(180deg,rgba(34,197,94,.08),rgba(0,0,0,0)); }
    .wrap{ max-width:1000px; margin:0 auto; padding:14px 16px; }
    h1{ margin:6px 0 10px; font-size:1.35rem; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .btn{ border:1px solid var(--border); background:var(--card); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn.primary{ background:var(--acc); color:#fff; border-color:transparent }
    .btn.warn{ background:var(--danger); color:#fff; border-color:transparent }
    .btn.ghost{ background:transparent }
    .grid{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); overflow:hidden; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:rgba(56,189,248,.08); position:sticky; top:0; z-index:1; padding:10px; text-align:right; border-bottom:1px solid var(--border); font-size:.95rem }
    tbody td{ border-bottom:1px dashed var(--border); padding:8px; vertical-align:middle }
    tbody tr:hover{ background:rgba(34,197,94,.06) }
    td[contenteditable="true"]{ background:rgba(0,0,0,.03); outline:none; border-radius:8px }
    .narrow{ width:60px; text-align:center }
    .time{ width:170px }
    .drag-handle{ cursor:grab; user-select:none }
    tr.dragging{ opacity:.5 }
    .done td{ text-decoration: line-through; color: #16a34a }
    .footer{ color:var(--muted); font-size:.85rem; text-align:center; margin:14px auto }
    canvas{ width:100% !important; max-height:320px }
    .toast{ position:fixed; inset-inline-start:50%; bottom:18px; transform:translateX(-50%); background:var(--card); color:var(--text); border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15); opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease }
    .toast.show{ opacity:1; transform:translate(-50%, -4px) }
    .badge{ font-size:.85rem; color:var(--muted) }
    @media (max-width:640px){ .time{ width:140px } .narrow{ width:50px } thead th:nth-child(2){display:none} tbody td:nth-child(2){display:none} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ“… Ø¬Ø¯ÙˆÙ„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ <span class="badge">ØªÙØ§Ø¹Ù„ÙŠØŒ Ù…Ø­ÙÙˆØ¸ØŒ Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span></h1>
      <div class="toolbar">
        <button class="btn primary" id="addRowBtn">â• Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø·</button>
        <button class="btn" id="toggleDark">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
        <button class="btn" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
        <label class="btn ghost" for="importFile">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <span class="badge">ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (LocalStorage)</span>
        <span class="badge" style="margin-inline-start:auto">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª: <span id="notifStatus">Ø¬Ø§Ø±Ù Ø§Ù„Ø·Ù„Ø¨â€¦</span></span>
        <button class="btn warn" id="resetBtn">â†º Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
      </div>
    </div>
  </header>

  <div class="wrap grid">
    <table id="schedule">
      <thead>
        <tr>
          <th class="narrow">â†•ï¸</th>
          <th class="narrow">âœ”ï¸</th>
          <th class="time">Ù…Ù† â€“ Ø¥Ù„Ù‰</th>
          <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="wrap grid" style="margin-top:12px; padding:12px">
    <h3 style="margin:8px 0">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
    <canvas id="statsChart" height="120"></canvas>
  </div>

  <p class="footer">Ù†ØµÙŠØ­Ø©: 50 Ø¯Ù‚ÙŠÙ‚Ø© ØªØ±ÙƒÙŠØ² + 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ø±Ø§Ø­Ø©. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø­Ø±ÙŠØ© ÙˆÙÙ‚ ÙŠÙˆÙ…Ùƒ ğŸ¤</p>

  <div id="toast" class="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…</div>

  <script>
    const tbody = document.querySelector('#schedule tbody');
    const toast = document.getElementById('toast');
    const notifStatus = document.getElementById('notifStatus');
    const DEFAULT_ROWS = [
      {time:'05:30 - 06:00', task:'ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø± + Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­', done:false},
      {time:'06:00 - 07:00', task:'Ø±ÙŠØ§Ø¶Ø© Ø®ÙÙŠÙØ© / Ù…Ø´ÙŠ', done:false},
      {time:'07:00 - 08:00', task:'Ø¥ÙØ·Ø§Ø± + Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„ÙŠÙˆÙ…', done:false},
      {time:'08:00 - 12:00', task:'Ø¯Ø±Ø§Ø³Ø©/Ø¨Ø±Ù…Ø¬Ø© Ù…Ø±ÙƒØ²Ø©', done:false},
      {time:'12:00 - 12:30', task:'ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø± + Ø§Ø³ØªØ±Ø§Ø­Ø©', done:false},
      {time:'12:30 - 14:00', task:'Ù…Ø°Ø§ÙƒØ±Ø© Ø®ÙÙŠÙØ© / Ù…Ø±Ø§Ø¬Ø¹Ø©', done:false},
      {time:'14:00 - 15:00', task:'ØºØ¯Ø§Ø¡ + Ù‚ÙŠÙ„ÙˆÙ„Ø©', done:false},
      {time:'15:00 - 16:30', task:'Ù‡ÙˆØ§ÙŠØ© (Ø±Ø³Ù…/Ù…Ø´Ø±ÙˆØ¹ Ø´Ø®ØµÙŠ)', done:false},
      {time:'16:30 - 17:00', task:'ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ± + Ø§Ø³ØªØ±Ø®Ø§Ø¡', done:false},
      {time:'17:00 - 19:00', task:'Ø¹Ø§Ø¦Ù„Ø©/Ø£ØµØ¯Ù‚Ø§Ø¡/Ø®Ø±ÙˆØ¬', done:false},
      {time:'19:00 - 19:30', task:'ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨ + Ù‚Ø±Ø¢Ù†', done:false},
      {time:'19:30 - 21:00', task:'ØªØ¹Ù„Ù‘Ù…/ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ', done:false},
      {time:'21:00 - 21:30', task:'ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡ + Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡', done:false},
      {time:'21:30 - 22:30', task:'ØªØ±ÙÙŠÙ‡ Ø®ÙÙŠÙ', done:false},
      {time:'22:30 - 23:00', task:'ØªØ­Ø¶ÙŠØ± Ù„Ù„ØºØ¯', done:false},
      {time:'23:00 - 05:30', task:'Ù†ÙˆÙ…', done:false},
    ];

    const STORAGE_KEY = 'life_schedule_interactive_v3';
    const THEME_KEY = 'life_theme';
    const NOTIF_LOG_KEY = 'life_notified_log';

    const $ = sel => document.querySelector(sel);

    function showToast(msg='ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…'){
      toast.textContent = msg; toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1400);
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      let rows = DEFAULT_ROWS;
      if(raw){ try{ rows = JSON.parse(raw); }catch{ rows = DEFAULT_ROWS; } }
      return rows;
    }
    function save(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

    function render(rows){
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.draggable = true;
        if(r.done) tr.classList.add('done');
        tr.innerHTML = `
          <td class="narrow drag-handle" title="Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨">â‹®â‹®</td>
          <td class="narrow"><input type="checkbox" ${r.done?'checked':''}></td>
          <td contenteditable="true" class="time">${escapeHtml(r.time)}</td>
          <td contenteditable="true">${escapeHtml(r.task)}</td>
        `;
        tbody.appendChild(tr);
      }
      wireRowEvents();
      updateChart();
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

    function getRows(){
      const rows = [];
      tbody.querySelectorAll('tr').forEach(tr=>{
        rows.push({
          done: tr.querySelector('input[type=checkbox]').checked,
          time: tr.children[2].textContent.trim(),
          task: tr.children[3].textContent.trim()
        });
      });
      return rows;
    }

    // Drag & Drop
    function wireRowEvents(){
      let dragged;
      tbody.querySelectorAll('tr').forEach(tr=>{
        tr.addEventListener('dragstart', e=>{ dragged = tr; tr.classList.add('dragging'); });
        tr.addEventListener('dragend', e=>{ tr.classList.remove('dragging'); save(getRows()); showToast(); });
        tr.addEventListener('dragover', e=>{ e.preventDefault(); const target = e.currentTarget; if(target!==dragged){ tbody.insertBefore(dragged, target); } });
        tr.querySelector('input[type=checkbox]').addEventListener('change', e=>{ tr.classList.toggle('done', e.target.checked); save(getRows()); updateChart(); });
        tr.querySelectorAll('td[contenteditable]')?.forEach(td=> td.addEventListener('input', ()=>{ save(getRows()); updateChart(); }));
      });
    }

    // Buttons
    $('#addRowBtn').addEventListener('click', ()=>{ tbody.insertAdjacentHTML('beforeend', `
      <tr draggable="true">
        <td class="narrow drag-handle">â‹®â‹®</td>
        <td class="narrow"><input type="checkbox"></td>
        <td contenteditable="true" class="time">00:00 - 00:00</td>
        <td contenteditable="true">Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</td>
      </tr>`); wireRowEvents(); save(getRows()); showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· â•'); updateChart(); });

    $('#resetBtn').addEventListener('click', ()=>{
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠØŸ')){ render(DEFAULT_ROWS); save(DEFAULT_ROWS); showToast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· â†º'); }
    });

    // Theme
    (function initTheme(){
      const savedTheme = localStorage.getItem(THEME_KEY);
      if(savedTheme==='dark') document.body.classList.add('dark');
      $('#toggleDark').addEventListener('click', ()=>{
        document.body.classList.toggle('dark');
        localStorage.setItem(THEME_KEY, document.body.classList.contains('dark')?'dark':'light');
      });
    })();

    // Export/Import
    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(getRows(), null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'life-schedule.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $('#importFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return; const text = await f.text();
      try{ const data = JSON.parse(text); if(Array.isArray(data)){ render(data); save(data); showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…'); } else alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
      catch{ alert('ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'); }
      e.target.value = '';
    });

    // Notifications (in-page + Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ù† ÙˆÙØ¬Ø¯)
    async function initNotifications(){
      try{
        if(!('Notification' in window)) { notifStatus.textContent = 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©'; return; }
        let perm = Notification.permission;
        if(perm === 'default') perm = await Notification.requestPermission();
        notifStatus.textContent = (perm==='granted') ? 'Ù…ÙØ¹Ù‘Ù„Ø©' : 'Ù…Ø±ÙÙˆØ¶Ø©';
      }catch{ notifStatus.textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­Ø©'; }
    }
    initNotifications();

    function timeToMinutes(hhmm){
      const m = hhmm.match(/^(\d{2}):(\d{2})$/); if(!m) return null; return (+m[1])*60 + (+m[2]);
    }
    function parseRange(s){
      const m = s.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/); if(!m) return null; return {from:m[1], to:m[2]};
    }

    function checkNotifications(){
      const now = new Date();
      const keyPrefix = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      const notified = new Set(JSON.parse(localStorage.getItem(NOTIF_LOG_KEY) || '[]'));
      const cur = (n=> `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`)(now);

      tbody.querySelectorAll('tr').forEach((tr, idx)=>{
        const task = tr.children[3].textContent.trim();
        const range = parseRange(tr.children[2].textContent.trim());
        if(!range) return;
        // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Ø´Ø§Ø·
        if(range.from === cur){
          const id = `${keyPrefix}-${idx}-${range.from}`;
          if(!notified.has(id)){
            inPageNotify(`Ø­Ø§Ù† ÙˆÙ‚Øª: ${task} (${range.from})`);
            try{ if('Notification' in window && Notification.permission==='granted'){ new Notification('ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¬Ø¯ÙˆÙ„', { body: `Ø­Ø§Ù† ÙˆÙ‚Øª: ${task}`, dir:'rtl' }); } }catch{}
            notified.add(id);
          }
        }
      });
      localStorage.setItem(NOTIF_LOG_KEY, JSON.stringify(Array.from(notified)));
    }

    function inPageNotify(msg){ showToast(msg); }

    setInterval(checkNotifications, 30000); // ÙØ­Øµ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©

    // Chart â€” ÙŠØ­Ø³Ø¨ Ø¨Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¥Ù† Ø£Ù…ÙƒÙ†
    let chart;
    function updateChart(){
      const map = new Map();
      tbody.querySelectorAll('tr').forEach(tr=>{
        const name = tr.children[3].textContent.trim() || 'ØºÙŠØ± Ù…Ø³Ù…Ù‰';
        const range = parseRange(tr.children[2].textContent.trim());
        let val = 1; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if(range){
          const a = timeToMinutes(range.from); const b = timeToMinutes(range.to);
          if(a!=null && b!=null){ val = (b - a + 1440) % 1440; if(val===0) val = 1; }
        }
        map.set(name, (map.get(name)||0) + val);
      });
      const labels = Array.from(map.keys());
      const data = Array.from(map.values());

      const ctx = document.getElementById('statsChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'pie',
        data:{ labels, datasets:[{ data, backgroundColor:['#22c55e','#0ea5e9','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#f97316','#84cc16','#06b6d4'] }]},
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    // Init
    (function init(){
      // Theme init
      if(localStorage.getItem('life_theme')==='dark') document.body.classList.add('dark');
      // Render
      render(load());
    })();
  </script>
</body>
</html>
